/*jslint browser:true devel:true sloppy:true plusplus:true nomen:true *//*global soundManager *//*global $ *//*global _ */// requires textinputs.jquery.js, found
// http://code.google.com/p/rangyinputs/wiki/Documentation
var TAAPP={},clone=function(a){var b=a instanceof Array?[]:{};for(i in a)a[i]&&typeof a[i]=="object"?b[i]=clone(a[i]):b[i]=a[i];return b};soundManager.setup({url:"swf/soundmanager2_flash9.swf",flashVersion:9,useFlashBlock:!1}),TAAPP.state={speechReauthor:{},speechSampleRate:44100},TAAPP.processPaste=function(a,b){var c=/(?:\[(\d+|gp)\]([^|]+)\|)/g,d=!1,e=TAAPP.ta.getSelection(),f=[];if(a.length-b.length+e.start!==0&&a.charAt(a.length-b.length+e.start)!==" "&&a.charAt(a.length-b.length+e.start-1)!==" "){console.log("Can't insert here (middle of word)!"),TAAPP.ta.val(a);return}while(result=c.exec(b))d=!0,result[1]==="gp"?f.push(result[2]):f.push(parseInt(result[1]));if(d){TAAPP.insertWords(f,a.length-b.length+e.start);return}TAAPP.ta.val(a)},TAAPP.processCopy=function(){var a=window.getSelection(),b=document.createElement("div"),c=TAAPP.ta.getSelection(),d=TAAPP.currentRange(c.start,c.end),e;e=_.reduce(d,function(a,b){var c;if(b.alignedWord==="gp")return console.log("copying gp"),a+"[gp]"+b.word+"|";for(c=0;c<TAAPP.words.length;c++)if(TAAPP.words[c].start===b.start&&TAAPP.words[c].end===b.end)break;return a+"["+c+"]"+b.word+"|"},""),b.style.position="absolute",b.style.left="-99999px",$("body").append(b),b.innerHTML=e,a.selectAllChildren(b),_.defer(function(){$(b).remove()})},TAAPP.processCut=function(){var a=TAAPP.ta.getSelection(),b=TAAPP.currentRange(a.start,a.end),c,d;TAAPP.updateText(),d=TAAPP.text,c=_.reduce(b,function(a,b){var c;for(c=0;c<TAAPP.words.length;c++)if(TAAPP.words[c].start===b.start&&TAAPP.words[c].end===b.end)break;return a+"["+c+"]"+b.word+"|"},""),d=d.slice(0,a.start)+c+d.slice(a.end+1),TAAPP.ta.val(d).setSelection(a.start,a.start+c.length)},TAAPP.processDelete=function(a){TAAPP.sound&&TAAPP.sound.pause(),TAAPP.snapSelectionToWord();var b=TAAPP.ta.getSelection(),c;b.length===0&&TAAPP.selectWord(a,!0),b=TAAPP.ta.getSelection(),c=b.end;while(TAAPP.text.charAt(c)===" ")c++;TAAPP.ta.setSelection(b.start,c),TAAPP.pruneCurrent(b.start,c)},TAAPP.currentRange=function(a,b){if(b===undefined){var c,d;for(c=0;c<TAAPP.current.length;c++)if(TAAPP.current[c].taPos>=a){d=TAAPP.current[c].taPos;break}return[d,c]}return console.log("currentrange",a,b),_.filter(TAAPP.current,function(c){return c.taPos>=a&&c.taPos<b})},TAAPP.pruneCurrent=function(a,b){TAAPP.current=_.filter(TAAPP.current,function(c){return c.taPos<a||c.taPos>=b}),TAAPP.updatePos()},TAAPP.insertWords=function(a,b){var c,d,e;for(c=0;c<TAAPP.current.length;c++)if(TAAPP.current[c].taPos>=b)break;var f={first:undefined,last:undefined};d=_.map(a,function(a){if(a.toString().split("-")[0]==="{gp"){var b=clone(TAAPP.roomTone[TAAPP.speech]);return b.word=a,b.pauseLength=parseFloat(a.split("-")[1]),f.first===undefined&&(this.first=b),this.last=b,b}var b=clone(TAAPP.words[a]);return f.first===undefined&&(this.first=b),this.last=b,b},f),e=[c,0].concat(d),Array.prototype.splice.apply(TAAPP.current,e),TAAPP.updateTextArea(),TAAPP.updatePos();var g=f.first.taPos,h=f.last.taPos+f.last.word.length;return TAAPP.ta.setSelection(h,h),[g,h]},TAAPP.selectWord=function(a){TAAPP.updateText();var b=TAAPP.ta[0].selectionStart,c;if(a==="backward"){c=b-1;while(TAAPP.text.charAt(c)===" "&&TAAPP.text.charAt(c)!=="")c--;TAAPP.ta.setSelection(c,b)}else if(a==="forward"){c=b+2;while(TAAPP.text.charAt(c)===" "&&TAAPP.text.charAt(c)!=="")c++;TAAPP.ta.setSelection(b,c)}TAAPP.snapSelectionToWord()},TAAPP.snapSelectionToWord=function(){TAAPP.updateText();var a=TAAPP.ta.getSelection(),b,c=!1,d=!1;/^\s+$/.exec(a.text)&&TAAPP.ta.collapseSelection();if(a.length>0){while(TAAPP.text.charAt(a.start)===" "){d=!0;if(!(a.start+1<a.end))break;TAAPP.ta.setSelection(a.start+1,a.end),a=TAAPP.ta.getSelection()}while(TAAPP.text.charAt(a.start-1)!==" "&&TAAPP.text.charAt(a.start-1)!==""&&b!==a.length&&!d)b=a.length,TAAPP.ta.setSelection(a.start-1,a.end),a=TAAPP.ta.getSelection();while(TAAPP.text.charAt(a.end-1)===" "){c=!0;if(!(a.start<a.end-1))break;TAAPP.ta.setSelection(a.start,a.end-1),a=TAAPP.ta.getSelection()}while(TAAPP.text.charAt(a.end)!==" "&&TAAPP.text.charAt(a.end)!==""&&b!==a.length&&!c)b=a.length,TAAPP.ta.setSelection(a.start,a.end+1),a=TAAPP.ta.getSelection()}},TAAPP.updateText=function(){TAAPP.text=TAAPP.ta.val(),TAAPP.emphasizeWords()},TAAPP.updatePos=function(){TAAPP.highlightWords(-1),_.each(TAAPP.current,function(a,b){TAAPP.current[b].taPos=this.total,this.total+=a.word.length+1},{total:0})},TAAPP.generateAudio=function(){TAAPP.state.speechReauthor={words:TAAPP.current};var a=document.createElement("img");a.src="img/spin.gif",$(".hlContainer").prepend(a),$(a).css("position","absolute").css("left","436px").css("top","200px"),$.ajax({url:"../reauthor",type:"POST",dataType:"json",contentType:"json",data:JSON.stringify(TAAPP.state),success:function(b){TAAPP.sound!==undefined&&TAAPP.sound.destruct(),TAAPP.sound=TAAPP.createSound(b),$(a).remove()},error:function(b){$(a).remove()}})},TAAPP.createSound=function(a){return soundManager.createSound({id:"speech",url:a.url,autoPlay:!0,onload:function(){_.each(a.timing,function(b,c,d){var e=b*1e3;TAAPP.timing=a.timing,this.onPosition(e,function(){TAAPP.highlightWords(c)})},this)},onfinish:function(){TAAPP.highlightWords(-1)}})},TAAPP.emphasizeWords=function(){var a=_.reduce(TAAPP.current,function(a,b,c){return b.emph!==undefined&&b.emph===!0?a+'<span class="emph">'+b.word+"</span> ":a+b.word+" "},"");$(".emphasis").html(a)},TAAPP.highlightWords=function(a,b){TAAPP.updateText();if(a===-1){TAAPP.currentHighlight=undefined,$(".highlights").html("");return}if(TAAPP.currentHighlight!==undefined&&TAAPP.currentHighlight[0]>a)return;TAAPP.currentHighlight=[a,b];var c=_.reduce(TAAPP.current,function(c,d,e){return e!==a||e!==b-1&&b!==undefined?e===a?c+'<span class="hl">'+d.word+" ":e===b-1?c+d.word+"</span> ":c+d.word+" ":c+'<span class="hl">'+d.word+"</span> "},"");$(".highlights").html(c)},TAAPP.adjustHeight=function(){TAAPP.ta.height("100px");var a=TAAPP.ta.prop("scrollHeight")+"px";TAAPP.ta.height(a),$(".highlights").height(a),$(".hlContainer").height(a),$(".emContainer").height(a),$(".emphasis").height(a)},TAAPP.playFromSelection=function(){var a=TAAPP.ta.getSelection(),b=TAAPP.currentRange(a.start),c,d=TAAPP.timing.length-1;console.log(b),console.log(TAAPP.timing);for(c=0;c<TAAPP.timing.length;c++)if(TAAPP.timing[c][0]>=b[1]){d=c-1;break}console.log(TAAPP.timing[d][1]*1e3),TAAPP.sound.stop(),TAAPP.sound.setPosition(TAAPP.timing[d][1]*1e3),TAAPP.sound.play()},TAAPP.roomTone={sedaris:{start:32.837,end:34.118,word:"{gpause}",alignedWord:"gp"},bullw:{start:123,end:124.266,word:"{gpause}",alignedWord:"gp"},scorerickard:{start:19.53,end:19.851,word:"{gpause}",alignedWord:"gp"}},TAAPP.loadOriginal=function(){var a={url:TAAPP.speech+".mp3",id:"orig",onLoad:function(){console.log("loaded original sound")},autoPlay:!1};TAAPP.origSound===undefined?soundManager.onready(function(){TAAPP.origSound=soundManager.createSound(a)}):(TAAPP.origSound.destruct(),TAAPP.origSound=soundManager.createSound(a))},TAAPP.reset=function(){TAAPP.state.speechText=TAAPP.speech+".json",TAAPP.state.speechAudio=TAAPP.speech+"44.wav",TAAPP.sound&&(TAAPP.sound.destruct(),TAAPP.sound=undefined),TAAPP.current=undefined,TAAPP.timing=undefined,TAAPP.currentHighlight=undefined,TAAPP.dupes=undefined,$(".dupeList").html(""),TAAPP.state.outfile=TAAPP.speech+"-"+TAAPP.outfile,$(".dlLink").prop("href","/download/"+TAAPP.state.outfile),TAAPP.loadOriginal(),$.getJSON(TAAPP.state.speechText,function(a){var b=a.words;TAAPP.words=b,TAAPP.current=clone(TAAPP.words),TAAPP.updatePos(),TAAPP.updateTextArea(),TAAPP.updateDupes()})},TAAPP.updateDupes=function(){$.ajax({url:"../dupes",type:"POST",dataType:"json",contentType:"json",data:JSON.stringify(TAAPP.state),success:function(a){TAAPP.dupes=a,TAAPP.drawScript()}})},TAAPP.updateTextArea=function(){TAAPP.ta.val(_.reduce(TAAPP.current,function(a,b){if(b.alignedWord==="UH"||b.alignedWord==="UM")b.emph=!0;return a+b.word+" "},"")),TAAPP.emphasizeWords(),TAAPP.adjustHeight()},TAAPP.drawScript=function(){_.each(TAAPP.dupes,function(a,b,c){var d=document.createElement("button"),e=document.createElement("button"),f=document.createElement("div");$(d).html('<i class="icon-play icon-white"></i>').addClass("btn btn-success").prop("type","button"),$(e).html('<i class="icon-plus icon-white"></i>').addClass("btn btn-primary");if(a.length===1){$(d).click(function(){TAAPP.origSound.play({from:1e3*TAAPP.words[a[0][0][0]].start,to:1e3*TAAPP.words[a[0][0][1]].end})});var g=document.createElement("div");$(g).addClass("btn-group").append(d).append(e);var h=document.createElement("span");$(h).text(a[0][1]).addClass("scriptLineText"),$(f).addClass("scriptLine").append(g).append(h),$(".dupeList").append(f)}else{var i=_.map(a,function(a,b){var c=document.createElement("option");return $(c).val(b).text(a[1]),c}),j=document.createElement("select");$(d).click(function(){var b=$(j).val(),c=a[b][0],d=TAAPP.words[c[0]].start,e=TAAPP.words[c[1]].end;TAAPP.origSound.play({from:d*1e3,to:e*1e3})}),$(e).click(function(){var b=$(j).val(),c=a[b][0],d=TAAPP.ta.getSelection();TAAPP.insertWords(_.range(c[0],c[1]+1),d.start)}),$(j).append(i).prop("name","dupe"+b).addClass("span10"),$(f).addClass("input-prepend").append(d).append(e).append(j),$(".dupeList").append(f)}})},TAAPP.loadSite=function(){$("select[name=speechSelect]").change(function(){console.log("Changing to "+$(this).val()),TAAPP.speech=$(this).val(),TAAPP.reset()}),TAAPP.speech=$("select[name=speechSelect]").val(),TAAPP.outfile=Math.random().toString(36).substring(12),TAAPP.reset(),$(".gPause").click(function(){TAAPP.updateText();var a=TAAPP.text,b=clone(TAAPP.roomTone[TAAPP.speech]);return b.word="{gp-"+parseFloat($(".gpLen").val())+"}",b.pauseLength=parseFloat($(".gpLen").val()),TAAPP.current.push(b),TAAPP.ta.val(a+b.word+" "),TAAPP.updatePos(),!1}),TAAPP.ta=$("#txtArea"),TAAPP.updateText(),$("#txtArea").bind("copy",function(a){console.log("copy",a),TAAPP.processCopy()}).bind("cut",function(a){console.log("cut",a),TAAPP.processCut()}).bind("paste",function(a){TAAPP.text=TAAPP.ta.val(),_.defer(function(){var a=TAAPP.processPaste(TAAPP.text,TAAPP.ta.val());TAAPP.updateText(),TAAPP.adjustHeight()})}).keypress(function(a){a.which>=32&&a.preventDefault()}).keydown(function(a){if(a.which===8)TAAPP.processDelete("backward");else if(a.which===46)TAAPP.processDelete("forward");else if([37,38,39,40].indexOf(a.which)!==-1)_.defer(TAAPP.snapSelectionToWord);else{if(a.which===13)return TAAPP.sound&&TAAPP.sound.pause(),TAAPP.highlightWords(-1),TAAPP.generateAudio(),!1;if(a.which===90)return!1;a.which===32&&TAAPP.sound&&TAAPP.playFromSelection()}}).bind("mouseup",TAAPP.snapSelectionToWord),$("body").keyup(function(a){a.keyCode===80&&TAAPP.sound.togglePause()}),$(window).resize(function(){TAAPP.adjustHeight()})},$(function(){TAAPP.loadSite()});